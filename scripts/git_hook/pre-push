#!/usr/bin/env bash
# Block pushing tags if unified release checks fail.
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
CHECK_SCRIPT="$ROOT_DIR/scripts/release_check.py"

status=0
while read -r local_ref local_sha remote_ref remote_sha; do
  [[ -z "${local_ref:-}" ]] && continue
  # Only validate created or updated tags
  if [[ "$local_ref" =~ ^refs/tags/ ]] && [[ "$local_sha" != 0000000000000000000000000000000000000000 ]]; then
    tag="${local_ref#refs/tags/}"
    python "$CHECK_SCRIPT" --tag "$tag" || status=1
  fi
done

exit "$status"
